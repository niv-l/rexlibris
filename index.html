<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rexlibris</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Titillium+Web:wght@300;400;600&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: #faf8f3;
            color: #1a1a1a;
            line-height: 1.6;
            min-height: 100vh;
        }

        .page {
            max-width: 620px;
            margin: 0 auto;
            padding: 4rem 1.5rem 3rem;
        }

        /* ── Header ── */

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            font-family: 'Titillium Web', sans-serif;
            font-weight: 300;
            font-size: 1.6rem;
            letter-spacing: 0.4em;
            text-transform: uppercase;
            color: #1a1a1a;
            margin-bottom: 0.15rem;
        }

        .subtitle {
            font-family: 'Crimson Pro', Georgia, serif;
            font-style: italic;
            font-size: 1.05rem;
            color: #888;
        }

        /* ── Controls ── */

        .controls {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 1.2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .field {
            display: flex;
            flex-direction: column;
        }

        .field label {
            font-family: 'Titillium Web', sans-serif;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #aaa;
            margin-bottom: 0.25rem;
        }

        select {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 300;
            border: none;
            border-bottom: 1px solid #ccc;
            background: transparent;
            padding: 0.25rem 0.1rem;
            color: #333;
            cursor: pointer;
            outline: none;
            border-radius: 0;
            -webkit-appearance: none;
            appearance: none;
        }

        select:focus {
            border-bottom-color: #5c3d2e;
        }

        /* ── Action ── */

        .action {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        #discover {
            font-family: 'Titillium Web', sans-serif;
            font-weight: 400;
            font-size: 0.8rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            background: none;
            border: 1px solid #bbb;
            color: #555;
            padding: 0.45rem 2.2rem;
            cursor: pointer;
            transition: border-color 0.15s, color 0.15s;
        }

        #discover:hover {
            border-color: #5c3d2e;
            color: #5c3d2e;
        }

        #discover:active {
            border-color: #3a2519;
            color: #3a2519;
        }

        #discover:disabled {
            opacity: 0.3;
            cursor: default;
        }

        /* ── Divider ── */

        .rule {
            border: none;
            border-top: 1px solid #ddd;
            margin: 0 0 2rem;
        }

        /* ── Results ── */

        #results {
            min-height: 4rem;
        }

        .result {
            margin-bottom: 2rem;
        }

        .result-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.3rem;
            font-weight: 600;
            line-height: 1.35;
            margin-bottom: 0.15rem;
            color: #1a1a1a;
        }

        .result-creator {
            font-family: 'Crimson Pro', Georgia, serif;
            font-style: italic;
            font-size: 1.05rem;
            color: #555;
            margin-bottom: 0.25rem;
        }

        .result-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem;
            font-weight: 300;
            color: #999;
            margin-bottom: 0.15rem;
        }

        .result-subjects {
            font-family: 'Titillium Web', sans-serif;
            font-size: 0.72rem;
            color: #999;
            margin-bottom: 0.15rem;
        }

        .result-description {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 0.95rem;
            color: #666;
            line-height: 1.5;
            margin-top: 0.4rem;
            margin-bottom: 0.3rem;
        }

        .result-link {
            font-family: 'Titillium Web', sans-serif;
            font-size: 0.75rem;
            margin-top: 0.4rem;
        }

        .result-link a {
            color: #5c3d2e;
            text-decoration: none;
            letter-spacing: 0.03em;
        }

        .result-link a:hover {
            border-bottom: 1px solid #5c3d2e;
        }

        .result + .result {
            padding-top: 1.8rem;
            border-top: 1px solid #e8e0d0;
        }

        /* ── States ── */

        .empty, .loading {
            text-align: center;
            font-style: italic;
            color: #bbb;
            padding: 1.5rem 0;
            font-size: 0.95rem;
        }

        /* ── Footer ── */

        footer {
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6rem;
            font-weight: 300;
            color: #ccc;
            margin-top: 3rem;
            letter-spacing: 0.02em;
        }

        /* ── Responsive ── */

        @media (max-width: 500px) {
            .page { padding: 2.5rem 1rem 2rem; }
            h1 { font-size: 1.3rem; letter-spacing: 0.3em; }
            .controls { gap: 0.8rem; }
            .result-title { font-size: 1.15rem; }
        }
    </style>
</head>
<body>
    <div class="page">
        <header>
            <h1>Rexlibris</h1>
            <p class="subtitle">Random Discovery</p>
        </header>

        <div class="controls">
            <div class="field">
                <label>Library</label>
                <select id="library"></select>
            </div>
            <div class="field">
                <label>Type</label>
                <select id="type">
                    <option value="">all</option>
                </select>
            </div>
            <div class="field">
                <label>Show</label>
                <select id="count">
                    <option value="1">1</option>
                    <option value="3" selected>3</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                </select>
            </div>
        </div>

        <div class="action">
            <button id="discover">Discover</button>
        </div>

        <hr class="rule">

        <div id="results">
            <p class="empty">Press Discover or Enter</p>
        </div>

        <footer>
            <span id="status"></span>
        </footer>
    </div>

    <script>
    (function () {
        'use strict';

        var libraryEl = document.getElementById('library');
        var typeEl    = document.getElementById('type');
        var countEl   = document.getElementById('count');
        var btn       = document.getElementById('discover');
        var results   = document.getElementById('results');
        var statusEl  = document.getElementById('status');

        function esc(s) {
            if (!s) return '';
            var d = document.createElement('span');
            d.textContent = s;
            return d.innerHTML;
        }

        function get(url) {
            return fetch(url).then(function (r) { return r.json(); });
        }

        function post(url, body) {
            return fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            }).then(function (r) { return r.json(); });
        }

        function updateStatus() {
            get('/api/status').then(function (s) {
                statusEl.textContent = s.pool_size + ' cached \u00b7 ' + s.word_count + ' words';
            }).catch(function () {});
        }

        function renderItem(item) {
            var h = '<div class="result-title">' + esc(item.title) + '</div>';
            if (item.creator && item.creator !== 'Unknown') {
                h += '<div class="result-creator">' + esc(item.creator) + '</div>';
            }
            h += '<div class="result-meta">' + esc(item.date) + ' \u00b7 ' + esc(item.type);
            if (item.language) h += ' \u00b7 ' + esc(item.language);
            if (item.publisher) h += ' \u00b7 ' + esc(item.publisher);
            h += '</div>';
            if (item.subjects && item.subjects.length) {
                h += '<div class="result-subjects">' + item.subjects.map(esc).join('; ') + '</div>';
            }
            if (item.description) {
                h += '<div class="result-description">' + esc(item.description) + '</div>';
            }
            if (item.url) {
                h += '<div class="result-link"><a href="' + esc(item.url) + '" target="_blank" rel="noopener">Open in catalog \u2192</a></div>';
            }
            return h;
        }

        function discover() {
            var n = countEl.value;
            btn.disabled = true;
            btn.textContent = '\u00b7\u00b7\u00b7';
            results.innerHTML = '<p class="loading">Searching\u2026</p>';

            get('/api/random?n=' + n).then(function (data) {
                if (!data.items || !data.items.length) {
                    results.innerHTML = '<p class="empty">Nothing found. Try again.</p>';
                    return;
                }
                results.innerHTML = '';
                data.items.forEach(function (item) {
                    var div = document.createElement('div');
                    div.className = 'result';
                    div.innerHTML = renderItem(item);
                    results.appendChild(div);
                });
            }).catch(function (e) {
                results.innerHTML = '<p class="empty">Error: ' + esc(e.message) + '</p>';
            }).finally(function () {
                btn.disabled = false;
                btn.textContent = 'Discover';
                updateStatus();
            });
        }

        function init() {
            var savedCount = localStorage.getItem('rexlibris_count');
            if (savedCount) countEl.value = savedCount;

            get('/api/libraries').then(function (data) {
                libraryEl.innerHTML = '';
                Object.keys(data.libraries).forEach(function (key) {
                    var opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = data.libraries[key].name;
                    if (key === data.active) opt.selected = true;
                    libraryEl.appendChild(opt);
                });
            });

            get('/api/types').then(function (data) {
                data.types.forEach(function (t) {
                    var opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                    typeEl.appendChild(opt);
                });
            });

            updateStatus();
        }

        btn.addEventListener('click', discover);

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && e.target.tagName !== 'SELECT') {
                e.preventDefault();
                discover();
            }
        });

        libraryEl.addEventListener('change', function () {
            post('/api/library', {key: libraryEl.value}).then(updateStatus);
        });

        typeEl.addEventListener('change', function () {
            post('/api/filter', {type: typeEl.value || null}).then(updateStatus);
        });

        countEl.addEventListener('change', function () {
            localStorage.setItem('rexlibris_count', countEl.value);
        });

        setInterval(updateStatus, 8000);
        init();
    })();
    </script>
</body>
</html>
